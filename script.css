const { createClient } = supabase;
const _supabase = createClient("https://zdixrufuczabxhvsvwsd.supabase.co", "sb_publishable_cQH31e8TGNu-KuWRIr6_xA_r5yA1eV8");

let currentUser = null;
let activeChannelId = null;
let localStream = null;

// --- GİRİŞ VE KAYIT ---
window.handleAuth = async (type) => {
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;
    const errorBox = document.getElementById('auth-error');
    errorBox.innerText = "";

    if (!email || !password) {
        errorBox.innerText = "E-posta ve şifre girin!";
        return;
    }

    try {
        const { data, error } = type === 'login' 
            ? await _supabase.auth.signInWithPassword({ email, password })
            : await _supabase.auth.signUp({ email, password });

        if (error) {
            errorBox.innerText = error.message;
            if(error.message.includes("confirm your email")) {
                errorBox.innerText = "Lütfen e-postanızı onaylayın veya Supabase'den bu ayarı kapatın!";
            }
        } else {
            checkUser();
        }
    } catch (e) {
        errorBox.innerText = "Bağlantı hatası!";
    }
};

async function checkUser() {
    const { data: { session } } = await _supabase.auth.getSession();
    if (session) {
        currentUser = session.user;
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('chat-screen').classList.remove('hidden');
        
        if (currentUser.email === 'test@test.com') {
            document.getElementById('admin-btn').classList.remove('hidden');
        }
        loadChannels();
    }
}

// --- KANAL VE MESAJ ---
async function loadChannels() {
    const { data } = await _supabase.from('channels').select('*');
    const list = document.getElementById('channel-list');
    list.innerHTML = '';
    data?.forEach(ch => {
        const b = document.createElement('button');
        b.className = "w-full text-left p-3 rounded-xl hover:bg-zinc-800 text-zinc-400 hover:text-white transition text-xs mb-1 font-bold border border-transparent";
        b.innerText = "# " + ch.name.toUpperCase();
        b.onclick = () => selectChannel(ch);
        list.appendChild(b);
    });
}

window.createChannel = async () => {
    const name = document.getElementById('new-channel-name').value.trim();
    if (!name) return;
    const { data } = await _supabase.from('channels').insert([{ name, creator_id: currentUser.id }]).select();
    if (data) {
        await _supabase.from('channel_members').insert([{ channel_id: data[0].id, user_id: currentUser.id }]);
        document.getElementById('new-channel-name').value = '';
        loadChannels();
    }
};

async function selectChannel(ch) {
    activeChannelId = ch.id;
    document.getElementById('header-text').innerText = "# " + ch.name.toUpperCase();
    document.getElementById('invite-btn').classList.remove('hidden');
    document.getElementById('call-btn').classList.remove('hidden');
    document.getElementById('chat-form').classList.remove('hidden');
    
    const { data } = await _supabase.from('messages').select('*').eq('channel_id', ch.id).order('created_at');
    const box = document.getElementById('messages');
    box.innerHTML = '';
    data?.forEach(addMsg);
    box.scrollTop = box.scrollHeight;

    _supabase.channel(`room-${ch.id}`).on('postgres_changes', { 
        event: 'INSERT', schema: 'public', table: 'messages', filter: 'channel_id=eq.' + ch.id 
    }, p => addMsg(p.new)).subscribe();
}

function addMsg(m) {
    const box = document.getElementById('messages');
    const isMe = m.user_id === currentUser.id;
    const d = document.createElement('div');
    d.className = `p-4 rounded-2xl w-fit max-w-sm shadow-lg ${isMe ? 'bg-blue-600 ml-auto rounded-tr-none' : 'bg-zinc-800 rounded-tl-none'}`;
    d.innerHTML = `<span class="text-[9px] font-black block mb-1 opacity-50 uppercase">${m.username}</span><span class="text-sm font-semibold">${m.content}</span>`;
    box.appendChild(d);
    box.scrollTop = box.scrollHeight;
}

document.getElementById('chat-form').onsubmit = async (e) => {
    e.preventDefault();
    const i = document.getElementById('msg-input');
    if (!i.value.trim()) return;
    await _supabase.from('messages').insert([{ 
        content: i.value, channel_id: activeChannelId, 
        username: currentUser.email.split('@')[0], user_id: currentUser.id 
    }]);
    i.value = '';
};

// --- DİĞERLERİ ---
window.toggleAdminPanel = async () => {
    const panel = document.getElementById('admin-panel');
    panel.classList.toggle('translate-x-full');
    if (!panel.classList.contains('translate-x-full')) {
        const { data } = await _supabase.from('channels').select('*');
        const list = document.getElementById('all-channels-list');
        list.innerHTML = '';
        data?.forEach(ch => {
            const div = document.createElement('div');
            div.className = "bg-zinc-800 p-4 rounded-2xl flex justify-between items-center border border-zinc-700";
            div.innerHTML = `<span class="text-xs font-bold"># ${ch.name}</span><button onclick="deleteChannel('${ch.id}')" class="text-[10px] bg-red-600 px-3 py-1 rounded-xl font-black">SİL</button>`;
            list.appendChild(div);
        });
    }
};

window.deleteChannel = async (id) => {
    if (confirm("Silinsin mi?")) {
        await _supabase.from('channels').delete().eq('id', id);
        toggleAdminPanel(); loadChannels();
    }
};

window.startCall = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    document.getElementById('video-panel').classList.remove('hidden');
    document.getElementById('localVideo').srcObject = stream;
    localStream = stream;
};

window.endCall = () => {
    localStream?.getTracks().forEach(t => t.stop());
    document.getElementById('video-panel').classList.add('hidden');
};

window.copyInviteLink = () => {
    const link = `${window.location.origin}${window.location.pathname}?invite=${activeChannelId}`;
    navigator.clipboard.writeText(link);
    alert("Link kopyalandı!");
};

window.logout = async () => { await _supabase.auth.signOut(); location.reload(); };

checkUser();
